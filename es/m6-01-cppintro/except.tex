\subsection{Excepciones}

\begin{frame}[t,fragile]{Excepciones}
\begin{itemize}
  \item El modelo de excepciones de C++ presenta diferencias con
        otros lenguajes.

  \pause\vfill
  \item Una excepción puede ser cualquier tipo definido por el usuario.
\begin{lstlisting}
class tiempo_invalido {};
\end{lstlisting}

  \pause\vfill
  \item Cuando una función detecta una situación excepcional lanza
        (\cppkey{throw}) una excepción.
\begin{lstlisting}
void imprime_velocidad(double s, double t) {
  if (t <= 0.0) {
    throw tiempo_invalido{};
  }
  std::println("velocidad = {}", s/t);
}
\end{lstlisting}

\end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Tratamiento de excepciones}
\begin{itemize}
  \item El llamante puede tratar una excepción con un bloque \cppkey{try}-\cppkey{catch}.
\begin{lstlisting}
void f() {
  double s = lee_espacio();
  double t = lee_tiempo();
  try {
    imprime_velocidad(s,t);
  }
  catch (tiempo_invalido) {
    std::println(std::cerr, "Error: tiempo no válido");
  }
}
\end{lstlisting}
  \vfill\pause
  \item No es necesario tratar una excepción $\rightarrow$ se propaga.
\begin{lstlisting}
void f() {
  double s = lee_espacio(), t = lee_tiempo();
  imprime_velocidad(s,t);
}
\end{lstlisting}
\end{itemize}
\end{frame}

\begin{frame}[t,fragile]{Excepciones estándar}
\begin{itemize}
  \item Varias excepciones predefinidas en la biblioteca estándar.
    \begin{itemize}
      \item \cppid{out\_of\_range}, \cppid{invalid\_argument}, \ldots
      \item Todos heredan de \cppid{exception}
      \item Todos tienen una función miembro \cppid{what()}.
    \end{itemize}
\end{itemize}

\mode<presentation>{\vspace{-.5em}}
\begin{columns}[T]

\column{.5\textwidth}
\begin{lstlisting}
struct tiempo_invalido : public std::invalid_argument{
  tiempo_invalido() :
    std::invalid_argument{"Tiempo no válido"} {}
};

void imprime_velocidad(double s, double t) {
  if (t <= 0.0) {
    throw tiempo_invalido{};
  }
  std::println("velocidad = {}", s/t);
}
\end{lstlisting}

\column{.5\textwidth}
\begin{lstlisting}
int main() try {
    f();
}
catch (std::out_of_range const & e) {
  std::cerr << "Fuera de rango:" << e.what() << "\n";
  return EXIT_FAILURE;
}
catch (std::exception const & e) {
  std::cerr << "Excepción: " << e.what() << "\n";
  return EXIT_FAILURE;
}
\end{lstlisting}
\end{columns}

\end{frame}
